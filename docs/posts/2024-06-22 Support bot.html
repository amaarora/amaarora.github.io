<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.21">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Aman Arora">
<meta name="dcterms.date" content="2024-06-22">
<meta name="description" content="As part of this blog post we will build a support bot on Slack that can respond to queries in a slack channel using Claudette (a thin python wrapper on top of Anthropic CLI)">

<title>Support bot with Claude 3.5 Sonnet using Claudette and Slack-SDK</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href=".././images/logo.png" rel="icon" type="image/png">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-ea1d7ac60288e0f1efdbc993fd8432ae.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-5b4ad623e5705c0698d39aec6f10cf02.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="../site_libs/quarto-contrib/videojs/video.min.js"></script>
<link href="../site_libs/quarto-contrib/videojs/video-js.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<script type="text/javascript">

(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-158677010-1', 'auto');

ga('send', {
  hitType: 'pageview',
  'anonymizeIp': true,
});
</script>


<meta name="twitter:title" content="Support bot with Claude 3.5 Sonnet using Claudette and Slack-SDK">
<meta name="twitter:description" content="As part of this blog post we will build a support bot on Slack that can respond to queries in a slack channel using Claudette (a thin python wrapper on top of Anthropic CLI)">
<meta name="twitter:image" content="../images/claudette-title.png">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../index.html" class="navbar-brand navbar-brand-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Aman Arora’s Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">Aman Arora</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/amaarora"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/amaarora"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://www.linkedin.com/in/aroraaman/"> <i class="bi bi-linkedin" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Support bot with Claude 3.5 Sonnet using Claudette and Slack-SDK</h1>
            <p class="subtitle lead">Creating a support bot that supports API calls using Claudette</p>
                  <div>
        <div class="description">
          <p>As part of this blog post we will build a support bot on Slack that can respond to queries in a slack channel using Claudette (a thin python wrapper on top of Anthropic CLI)</p>
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">LLM</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Aman Arora </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">June 22, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#creating-a-slack-app" id="toc-creating-a-slack-app" class="nav-link active" data-scroll-target="#creating-a-slack-app"><span class="header-section-number">1</span> Creating a slack APP</a></li>
  <li><a href="#support-bot-using-claudette" id="toc-support-bot-using-claudette" class="nav-link" data-scroll-target="#support-bot-using-claudette"><span class="header-section-number">2</span> Support Bot using Claudette</a></li>
  <li><a href="#claudette-in-slack" id="toc-claudette-in-slack" class="nav-link" data-scroll-target="#claudette-in-slack"><span class="header-section-number">3</span> Claudette in Slack</a></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion"><span class="header-section-number">4</span> Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<div class="quarto-video"><video id="video_shortcode_videojs_video1" class="video-js vjs-default-skin vjs-fluid" controls="" preload="auto" data-setup="{}" title="Claudette in Slack"><source src="../images/claudette.mp4"></video></div>
<p><strong>Problem Statement:</strong> You are the owner of a graphical and tech company called <em>“DRAMA77IC”</em> that creates dramatic and graphical visualisations for games for users all over the world. You have an API that contains information about various games such as genre, date of release, description and so on. You want to create a support channel, so your users can directly ask questions about your offerings, place orders and also return games through this Slack channel.</p>
<p>Now that we have a well defined problem statement, let’s go about creating a solution using <code>Claudette</code>!</p>
<p>Recently Answer.AI team released <a href="https://www.answer.ai/posts/2024-06-21-claudette.html">Claudette</a>. It is built on top of Claude 3.5 Sonnet - the most powerful language model at the time of writing this blog post.</p>
<p>As part of this blog post, I will show you how to use Claudette to create a support bot built on top of Slack. You should be able to easily integrate the steps shown below to respond to user queries by calling any function. Claudette also supports multiple function calls, so you can call a chain of functions to respond to user queries.</p>
<p>There are two parts to this blog post.</p>
<ol type="1">
<li>Create a slack app - this is just setup to create a slack application so that we can respond to user messages automatically.</li>
<li>Integrate this slack application with Claude using Claudette.</li>
</ol>
<p>Finally, we woll test this out and showcase a demo.</p>
<section id="creating-a-slack-app" class="level2" data-number="1">
<h2 data-number="1" class="anchored" data-anchor-id="creating-a-slack-app"><span class="header-section-number">1</span> Creating a slack APP</h2>
<p>For the purpose of this blog post, I created a new workspace on Slack and also created a new app called “support-bot”.</p>
<p>You can go to https://api.slack.com/apps and create a new app.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/support-bot.png" class="img-fluid figure-img"></p>
<figcaption>support-bot</figcaption>
</figure>
</div>
<p>Next, here’s what you want to do:</p>
<ol type="1">
<li>Enable socket mode, when you do this, a new APP level token will also be created with scope <code>connections:write</code>.</li>
<li>Go over to <strong>OAuth &amp; Permissions</strong> and add the following scopes:
<ol type="1">
<li><em>app_mentions:read</em></li>
<li><em>channels:history</em></li>
<li><em>channels:read</em></li>
<li><em>chat:write</em></li>
<li><em>im:history</em></li>
<li><em>im:read</em></li>
<li><em>im:write</em></li>
<li><em>reactions:write</em></li>
</ol></li>
<li>Enable event subscriptions.</li>
<li>Install your bot to workspace and add it to your support channel.</li>
</ol>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/token-scopes.png" class="img-fluid figure-img"></p>
<figcaption>scopes</figcaption>
</figure>
</div>
<p>We are now ready to start sending messages to public slack channels using our bot. Copy over your <code>SLACK_APP_TOKEN</code> and <code>SLACK_BOT_TOKEN</code> to a <code>.env</code> file and let’s use <code>dotenv</code> to load them.</p>
<div id="2f0f765c" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dotenv</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>dotenv.load_dotenv()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>True</code></pre>
</div>
</div>
<p>Now let’s make some imports and get our <code>BOT_USER_ID</code>. Each user in Slack has a <code>user_id</code>. To read more about the slack client, refer <a href="https://slack.dev/python-slack-sdk/web/index.html">here</a>.</p>
<div id="1138b0c0" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slack_sdk <span class="im">import</span> WebClient</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slack_sdk.errors <span class="im">import</span> SlackApiError</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="329f4766" class="cell" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> WebClient(token<span class="op">=</span>os.environ[<span class="st">"SLACK_BOT_TOKEN"</span>])</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>BOT_USER_ID <span class="op">=</span> client.auth_test()[<span class="st">"user_id"</span>]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>BOT_USER_ID</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="3">
<pre><code>'U07932L0L5U'</code></pre>
</div>
</div>
<p>You can also add the channel ID to your dotenv, and we can load it like below:</p>
<div id="2ae8ef04" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>channel_id <span class="op">=</span> os.environ[<span class="st">'LISTEN_CHANNEL_ID'</span>]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>channel_id</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>'C078V28044F'</code></pre>
</div>
</div>
<p>To post the message to your channel, simply use <code>client.chat_postMessage</code>. But, before you do that, make sure to add the support-bot to your channel.</p>
<p>I created a new channel called #blog and added support-bot to it.</p>
<div id="892e99a4" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> client.chat_postMessage(</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">=</span>channel_id, </span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span><span class="st">"Bonjour! My name is Claudia, I am your support-bot for DRAMA77IC, a made-up company name for blogging purposes."</span>, </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/welcome-message.png" class="img-fluid figure-img"></p>
<figcaption>weclome-message</figcaption>
</figure>
</div>
<p>A little bit more about slack - each message in Slack has a timestamp represented by <code>ts</code>.</p>
<div id="6f6e6995" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>message <span class="op">=</span> client.conversations_history(channel<span class="op">=</span>channel_id)[<span class="st">'messages'</span>][<span class="dv">0</span>]</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>message</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<pre><code>{'user': 'U07932L0L5U',
 'type': 'message',
 'ts': '1719101633.566529',
 'bot_id': 'B079C5SV99A',
 'app_id': 'A079C53DT9A',
 'text': 'Bonjour! My name is Claudia, I am your support-bot for DRAMA77IC, a made-up company name for blogging purposes.',
 'team': 'T079C2R49GC',
 'bot_profile': {'id': 'B079C5SV99A',
  'deleted': False,
  'name': 'support-bot',
  'updated': 1719017903,
  'app_id': 'A079C53DT9A',
  'icons': {'image_36': 'https://a.slack-edge.com/80588/img/plugins/app/bot_36.png',
   'image_48': 'https://a.slack-edge.com/80588/img/plugins/app/bot_48.png',
   'image_72': 'https://a.slack-edge.com/80588/img/plugins/app/service_72.png'},
  'team_id': 'T079C2R49GC'},
 'blocks': [{'type': 'rich_text',
   'block_id': 'Xwfz',
   'elements': [{'type': 'rich_text_section',
     'elements': [{'type': 'text',
       'text': 'Bonjour! My name is Claudia, I am your support-bot for DRAMA77IC, a made-up company name for blogging purposes.'}]}]}]}</code></pre>
</div>
</div>
<p>To respond to this very message, we can pass in the timestamp as a <code>thread_ts</code> parameter. This allows to respond to the message in a thread rather than posting a new message on the Slack channel.</p>
<div id="37d4db3b" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>response <span class="op">=</span> client.chat_postMessage(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>        channel<span class="op">=</span>channel_id, </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        text<span class="op">=</span><span class="st">"I was just told to respond to my own message. So I am doing that."</span>, </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        thread_ts<span class="op">=</span>message[<span class="st">'ts'</span>]</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<!-- <img src="../images/thread-response.png" alt="alt text" title="Title" align="center" width="500"> -->
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="../images/thread-response.png" class="img-fluid figure-img"></p>
<figcaption>response</figcaption>
</figure>
</div>
<p>Now we have the basics in place to start working on our support-bot using Claudette.</p>
<p>Essentially what we want to do is to allow Claude 3.5 Sonnet to talk to the customers a customer support agent. To do that, we want to automate the process of reading new slack messages, sharing them with Claude 3.5 Sonnet, getting a response and posting it back to the user.</p>
</section>
<section id="support-bot-using-claudette" class="level2" data-number="2">
<h2 data-number="2" class="anchored" data-anchor-id="support-bot-using-claudette"><span class="header-section-number">2</span> Support Bot using Claudette</h2>
<p>First things first, let’s install the library.</p>
<pre><code>pip install claudette</code></pre>
<div id="b1eefa8d" class="cell" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slack_sdk.web <span class="im">import</span> WebClient</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slack_sdk.socket_mode <span class="im">import</span> SocketModeClient</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slack_sdk.socket_mode.response <span class="im">import</span> SocketModeResponse</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> slack_sdk.socket_mode.request <span class="im">import</span> SocketModeRequest</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> dotenv</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> datetime <span class="im">import</span> datetime, timedelta</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> claudette <span class="im">import</span> <span class="op">*</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ad6f5032" class="cell" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># claude's latest and most powerful version</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>model<span class="op">=</span><span class="st">'claude-3-5-sonnet-20240620'</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="ce05f2b1" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># `sp` stands for system prompt</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model<span class="op">=</span>model, </span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>            sp<span class="op">=</span><span class="st">"You are Claudia. Do not share what tools you use to respond to user requests."</span>)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>chat(<span class="st">"Hi, I'm Alice."</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="10">
<p>Hello Alice! It’s nice to meet you. I’m Claudia. How are you doing today? Is there anything in particular you’d like to chat about?</p>
<details>
<ul>
<li>id: msg_01HzdXGnHQFFtHAGMZfqU8Fj</li>
<li>content: [{‘text’: “Hello Alice! It’s nice to meet you. I’m Claudia. How are you doing today? Is there anything in particular you’d like to chat about?”, ‘type’: ‘text’}]</li>
<li>model: claude-3-5-sonnet-20240620</li>
<li>role: assistant</li>
<li>stop_reason: end_turn</li>
<li>stop_sequence: None</li>
<li>type: message</li>
<li>usage: {‘input_tokens’: 31, ‘output_tokens’: 36}</li>
</ul>
</details>
</div>
</div>
<p>Now, the best part about <code>claudette</code> is that it allows function calling and it has been made really simple.</p>
<p>If you have used function calling before, you would know that OpenAI and Anthropic expect functions to be defined in a certain manner.</p>
<p>For example, from Anthropic <a href="https://docs.anthropic.com/en/docs/build-with-claude/tool-use">docs</a>:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>      {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>        <span class="st">"name"</span>: <span class="st">"get_weather"</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>        <span class="st">"description"</span>: <span class="st">"Get the current weather in a given location"</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">"input_schema"</span>: {</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>          <span class="st">"type"</span>: <span class="st">"object"</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>          <span class="st">"properties"</span>: {</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"location"</span>: {</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">"type"</span>: <span class="st">"string"</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>              <span class="st">"description"</span>: <span class="st">"The city and state, e.g. San Francisco, CA"</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>          },</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>          <span class="st">"required"</span>: [<span class="st">"location"</span>]</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>      }</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>To define a function <code>get_weather</code> that takes in an input parameter <code>location</code>, this is a rather tedious way of having to write the function.</p>
<p>Especially when we write all functions in Python itself. Having to convert a function like below:</p>
<pre><code>def get_weather(
    location: str
):
    weather_in_celsius = API_CALL(location)
    return weather_in_celsius</code></pre>
<p>Having to convert a simple Python function like above to the required format is rather tedious. Enter claudette!</p>
<p>Claudette has this function called <code>get_schema</code> that is able to convert a python function to the desired format.|</p>
<div id="5360228f" class="cell" data-execution_count="50">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> toolslm.funccall <span class="im">import</span> get_schema</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_weather(</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>    location: <span class="bu">str</span> <span class="co"># The city and state, eg. San Francisco, CA</span></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Get the current weather in a given location"</span></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    weather_in_celsius <span class="op">=</span> API_CALL(location)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> weather_in_celsius</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>get_schema(get_weather)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="50">
<pre><code>{'name': 'get_weather',
 'description': 'Get the current weather in a given location',
 'input_schema': {'type': 'object',
  'properties': {'location': {'type': 'string',
    'description': 'The city and state, eg. San Francisco, CA'}},
  'required': ['location']}}</code></pre>
</div>
</div>
<p>This is really handy especially when we want to pass in multiple functions to Claude to choose from.</p>
<p>As part of this blog post, let’s demo function calling with a dummy example. This data has been modified from Anthropic’s example <a href="https://github.com/anthropics/anthropic-cookbook/blob/main/tool_use/customer_service_agent.ipynb">here</a>.</p>
<p>Let’s say the company has the following five games - G1 to G5 and two customers C1 &amp; C2.</p>
<div id="889ea158" class="cell" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>customers <span class="op">=</span> {</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C1"</span>: <span class="bu">dict</span>(name<span class="op">=</span><span class="st">"Alice Johnson"</span>, email<span class="op">=</span><span class="st">"alice@example.com"</span>, phone<span class="op">=</span><span class="st">"123-456-7890"</span>,</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>               games<span class="op">=</span>[<span class="st">"G1"</span>, <span class="st">"G2"</span>, <span class="st">"G3"</span>]),</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"C2"</span>: <span class="bu">dict</span>(name<span class="op">=</span><span class="st">"Bob Smith"</span>, email<span class="op">=</span><span class="st">"bob@example.com"</span>, phone<span class="op">=</span><span class="st">"987-654-3210"</span>,</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>               games<span class="op">=</span>[<span class="st">"G4"</span>, <span class="st">"G5"</span>])</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>games <span class="op">=</span> {</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G1"</span>: <span class="bu">dict</span>(<span class="bu">id</span><span class="op">=</span><span class="st">"G1"</span>, name<span class="op">=</span><span class="st">"Shadow Realms"</span>, release_date<span class="op">=</span><span class="st">"2023-03-15"</span>, description<span class="op">=</span><span class="st">"Navigate enchanted forests and haunted castles."</span>, status<span class="op">=</span><span class="st">"Shipped"</span>),</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G2"</span>: <span class="bu">dict</span>(<span class="bu">id</span><span class="op">=</span><span class="st">"G2"</span>, name<span class="op">=</span><span class="st">"Solar Winds"</span>, release_date<span class="op">=</span><span class="st">"2023-07-22"</span>, description<span class="op">=</span><span class="st">"Explore space with stunning visuals and alien planets."</span>, status<span class="op">=</span><span class="st">"Shipped"</span>),</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G3"</span>: <span class="bu">dict</span>(<span class="bu">id</span><span class="op">=</span><span class="st">"G3"</span>, name<span class="op">=</span><span class="st">"Mystic Legends"</span>, release_date<span class="op">=</span><span class="st">"2023-11-10"</span>, description<span class="op">=</span><span class="st">"Epic fantasy RPG with beautiful landscapes."</span>, status<span class="op">=</span><span class="st">"Shipped"</span>),</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G4"</span>: <span class="bu">dict</span>(<span class="bu">id</span><span class="op">=</span><span class="st">"G4"</span>, name<span class="op">=</span><span class="st">"Cyber Revolution"</span>, release_date<span class="op">=</span><span class="st">"2024-02-28"</span>, description<span class="op">=</span><span class="st">"Dystopian future with advanced technology and cyber warfare."</span>, status<span class="op">=</span><span class="st">"Shipped"</span>),</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">"G5"</span>: <span class="bu">dict</span>(<span class="bu">id</span><span class="op">=</span><span class="st">"G5"</span>, name<span class="op">=</span><span class="st">"Desert Storm"</span>, release_date<span class="op">=</span><span class="st">"2024-05-05"</span>, description<span class="op">=</span><span class="st">"Tactical shooter in a war-torn desert."</span>, status<span class="op">=</span><span class="st">"Processing"</span>)</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s now define some functions to get customer information, game information and also return games if needed.</p>
<div id="6f7718f5" class="cell" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_customer_info(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>    customer_id: <span class="bu">str</span>  <span class="co"># ID of the customer</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>):  <span class="co"># Customer's name, email, phone number, and list of games</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Retrieves a customer's information and their orders based on the customer ID"</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'- Retrieving customer </span><span class="sc">{</span>customer_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> customers.get(customer_id, <span class="st">"Customer not found"</span>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_game_details(</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>    game_id: <span class="bu">str</span>  <span class="co"># ID of the game</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>):  <span class="co"># Game's ID, name, release date, description &amp; status</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Retrieves the details of a specific game based on the game ID"</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'- Retrieving game </span><span class="sc">{</span>game_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> games.get(game_id, <span class="st">"Game not found"</span>)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> return_game(</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>    game_id:<span class="bu">str</span> <span class="co"># ID of the order to cancel</span></span>
<span id="cb21-17"><a href="#cb21-17" aria-hidden="true" tabindex="-1"></a>)<span class="op">-&gt;</span><span class="bu">bool</span>: <span class="co"># True if the return is successful</span></span>
<span id="cb21-18"><a href="#cb21-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Returns a game to the cmpany based on game ID."</span></span>
<span id="cb21-19"><a href="#cb21-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'- Returning game </span><span class="sc">{</span>game_id<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb21-20"><a href="#cb21-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> game_id <span class="kw">not</span> <span class="kw">in</span> games: <span class="cf">return</span> <span class="va">False</span></span>
<span id="cb21-21"><a href="#cb21-21" aria-hidden="true" tabindex="-1"></a>    games[game_id][<span class="st">'status'</span>] <span class="op">=</span> <span class="st">'Returned'</span></span>
<span id="cb21-22"><a href="#cb21-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">True</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now we can simply define these tools with claudette. Note, as previously mentioned, we no longer need to provide the chunky json version, <code>claudette</code> automatically handles that for us using docments.</p>
<div id="877e7014" class="cell" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>tools <span class="op">=</span> [get_customer_info, get_game_details, return_game]</span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a>chat <span class="op">=</span> Chat(model, tools<span class="op">=</span>tools)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Let’s now do a function call as customer C1 and return one of the games.</p>
<div id="016f7640" class="cell" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(<span class="st">'Hi! How are you? This is Alice Johnson. (Customer ID: "C1")'</span>)</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r.stop_reason)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>r.content</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>end_turn</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>[TextBlock(text="Hello Alice Johnson! It's great to hear from you. I'm doing well, thank you for asking. I hope you're doing well too. \n\nI see that you've provided your Customer ID. That's very helpful! Would you like me to retrieve your customer information and order details? I can do that for you using the Customer ID you've provided. This will allow me to assist you better with any questions or concerns you might have. \n\nShall I go ahead and fetch your customer information?", type='text')]</code></pre>
</div>
</div>
<div id="d9aed58d" class="cell" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(<span class="st">'Can you tell me more about the games I currently have? Just give me a list of games I own.'</span>)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r.stop_reason)</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>r.content</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>- Retrieving customer C1
tool_use</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="15">
<pre><code>[TextBlock(text="Certainly, Alice! I'd be happy to help you with that. To get the information about the games you currently have, I'll need to retrieve your customer information first. I'll use the Customer ID you provided to do this.", type='text'),
 ToolUseBlock(id='toolu_01TrdXW3C3VfJpcLi9UMeyYp', input={'customer_id': 'C1'}, name='get_customer_info', type='tool_use')]</code></pre>
</div>
</div>
<p>Claude recognises that we are doing a function call to retrieve information about C1. Claudette let’s you call the function automatically by simply calling it again.</p>
<div id="aec52b9b" class="cell" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat()</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents(r))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Thank you for your patience, Alice. I've retrieved your customer information, including the list of games you currently own. Here's a list of the games associated with your account:

1. Game ID: G1
2. Game ID: G2
3. Game ID: G3

These are the games you currently have in your possession. Would you like more detailed information about any of these games? I can provide you with specific details for each game if you're interested. Just let me know which game(s) you'd like to know more about, and I'll be happy to fetch that information for you.</code></pre>
</div>
</div>
<div id="26a96484" class="cell" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(<span class="st">"No, that's fine. Can you just return my game G2? I don't want it anymore."</span>)</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r.stop_reason)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>r.content</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>- Returning game G2
tool_use</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>[TextBlock(text="Certainly, Alice. I understand that you want to return the game with ID G2. I'd be happy to help you process that return. I'll use the return_game function to do this for you right away.", type='text'),
 ToolUseBlock(id='toolu_018X45fRcYQ69TL4MUZS5rXg', input={'game_id': 'G2'}, name='return_game', type='tool_use')]</code></pre>
</div>
</div>
<div id="a67c01c0" class="cell" data-execution_count="18">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(contents(r))</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Great news, Alice! The return for game G2 has been successfully processed. The system confirms that the return was completed successfully.

To summarize:
- You've returned the game with ID G2.
- The return has been recorded in our system.
- You should no longer have this game in your possession.

Is there anything else you'd like me to help you with regarding your games or account? Perhaps you'd like to know more about the remaining games you have, or if you have any other questions, I'm here to assist.</code></pre>
</div>
</div>
<div id="1b9ba8f9" class="cell" data-execution_count="19">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> chat(<span class="st">"That's it. Thank you Claudia."</span>)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(r.stop_reason)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>r.content</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>end_turn</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>[TextBlock(text="You're welcome, Alice! I'm glad I could help you with returning game G2. \n\nJust a small correction: my name isn't Claudia. I'm an AI assistant without a specific name. But I'm always here to help you with any questions or concerns you might have about your games or account.\n\nIs there anything else you need assistance with today? If not, I hope you have a wonderful day!", type='text')]</code></pre>
</div>
</div>
<p>We can also check the total token use as claudette automatically monitors that for us.</p>
<div id="73345696" class="cell" data-execution_count="21">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># we can also check the total tokens used in our conversation</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>chat.use</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="21">
<pre><code>In: 5609; Out: 658; Total: 6267</code></pre>
</div>
</div>
<p>Also, in the example above we have just returned one game. What if we wanted to return multiple games? We would have to call the <code>return_game</code> function in a loop. This is rather tedious.</p>
<p>Claudette has a function called <code>toolloop</code>, this allows to call multiple functions (you can define maximum number of multiple function calls) until the model has completed the request. Let’s see it in action.</p>
<div id="ca69fc77" class="cell" data-execution_count="22">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>chat.toolloop(<span class="st">"Hey Claudia. Can you return all the games for me?"</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>- Returning game G1
- Returning game G3</code></pre>
</div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="22">
<p>Great news! I’ve successfully processed the returns for both of your remaining games. Here’s a summary:</p>
<ol type="1">
<li>Game G1: Successfully returned</li>
<li>Game G3: Successfully returned</li>
</ol>
<p>All of your games have now been returned to the company. Your account should no longer have any active game rentals.</p>
<p>Is there anything else you would like me to help you with regarding your account or our services?</p>
<details>
<ul>
<li>id: msg_01SKrBoyXMbFNUF2uWGFErZK</li>
<li>content: [{‘text’: “Great news! I’ve successfully processed the returns for both of your remaining games. Here’s a summary:. Game G1: Successfully returned. Game G3: Successfully returnedof your games have now been returned to the company. Your account should no longer have any active game rentals.there anything else you would like me to help you with regarding your account or our services?”, ‘type’: ‘text’}]</li>
<li>model: claude-3-5-sonnet-20240620</li>
<li>role: assistant</li>
<li>stop_reason: end_turn</li>
<li>stop_sequence: None</li>
<li>type: message</li>
<li>usage: {‘input_tokens’: 1633, ‘output_tokens’: 88}</li>
</ul>
</details>
</div>
</div>
<p>There you go! Now, we were able to call multiple functions in a loop. Which is great. To confirm let’s check the <code>games</code> dict and confirm that the order status has changed.</p>
<div id="b89ce560" class="cell" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>games</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="23">
<pre><code>{'G1': {'id': 'G1',
  'name': 'Shadow Realms',
  'release_date': '2023-03-15',
  'description': 'Navigate enchanted forests and haunted castles.',
  'status': 'Returned'},
 'G2': {'id': 'G2',
  'name': 'Solar Winds',
  'release_date': '2023-07-22',
  'description': 'Explore space with stunning visuals and alien planets.',
  'status': 'Returned'},
 'G3': {'id': 'G3',
  'name': 'Mystic Legends',
  'release_date': '2023-11-10',
  'description': 'Epic fantasy RPG with beautiful landscapes.',
  'status': 'Returned'},
 'G4': {'id': 'G4',
  'name': 'Cyber Revolution',
  'release_date': '2024-02-28',
  'description': 'Dystopian future with advanced technology and cyber warfare.',
  'status': 'Shipped'},
 'G5': {'id': 'G5',
  'name': 'Desert Storm',
  'release_date': '2024-05-05',
  'description': 'Tactical shooter in a war-torn desert.',
  'status': 'Processing'}}</code></pre>
</div>
</div>
<p>As can be seen from the dictionary above, we can see that games <code>G1</code>, <code>G2</code> &amp; <code>G3</code> have been returned.</p>
<p>Now, that’s a good looking customer support conversation but we want to have this in Slack instead. For that case, we will write a small Python script that constantly monitors the channel and looks for new messages. Claudette only responds if the bot has been mentioned with “<span class="citation" data-cites="support-bot">(<a href="#ref-support-bot" role="doc-biblioref"><strong>support-bot?</strong></a>)</span>”. Let’s go ahead and write that script now and show it in action.</p>
</section>
<section id="claudette-in-slack" class="level2" data-number="3">
<h2 data-number="3" class="anchored" data-anchor-id="claudette-in-slack"><span class="header-section-number">3</span> Claudette in Slack</h2>
<p>Now that we have a good idea on how to use claudette for function calling, let’s integrate it with Slack so that we can allow our support-bot to respond to user queries in a thread.</p>
<p>Mostly all, we need is a process function like below:</p>
<div class="code-copy-outer-scaffold"><div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process(client: SocketModeClient, req: SocketModeRequest):</span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(req.payload)</span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> req.<span class="bu">type</span> <span class="op">==</span> <span class="st">"events_api"</span> <span class="kw">or</span> req.<span class="bu">type</span> <span class="op">==</span> <span class="st">"event_callback"</span>:</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        response <span class="op">=</span> SocketModeResponse(envelope_id<span class="op">=</span>req.envelope_id)</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>        client.send_socket_mode_response(response)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>            req.payload[<span class="st">"event"</span>][<span class="st">"type"</span>] <span class="op">==</span> <span class="st">"message"</span></span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>            <span class="kw">and</span> req.payload[<span class="st">"event"</span>].get(<span class="st">"subtype"</span>) <span class="kw">is</span> <span class="va">None</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>            <span class="kw">and</span> <span class="st">"bot_profile"</span> <span class="kw">not</span> <span class="kw">in</span> req.payload[<span class="st">"event"</span>].keys()</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>        ):</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>            thread_ts <span class="op">=</span> req.payload[<span class="st">"event"</span>][<span class="st">"ts"</span>]</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="st">"thread_ts"</span> <span class="kw">in</span> req.payload[<span class="st">"event"</span>].keys():</span>
<span id="cb45-13"><a href="#cb45-13" aria-hidden="true" tabindex="-1"></a>                thread_ts <span class="op">=</span> req.payload[<span class="st">"event"</span>][<span class="st">"thread_ts"</span>]</span>
<span id="cb45-14"><a href="#cb45-14" aria-hidden="true" tabindex="-1"></a>            text <span class="op">=</span> req.payload[<span class="st">"event"</span>][<span class="st">"text"</span>]</span>
<span id="cb45-15"><a href="#cb45-15" aria-hidden="true" tabindex="-1"></a>            r <span class="op">=</span> chat.toolloop(text, maxtok<span class="op">=</span><span class="dv">200</span>)</span>
<span id="cb45-16"><a href="#cb45-16" aria-hidden="true" tabindex="-1"></a>            response <span class="op">=</span> _client.chat_postMessage(</span>
<span id="cb45-17"><a href="#cb45-17" aria-hidden="true" tabindex="-1"></a>                channel<span class="op">=</span>CHANNEL_ID, text<span class="op">=</span>contents(r), thread_ts<span class="op">=</span>thread_ts</span>
<span id="cb45-18"><a href="#cb45-18" aria-hidden="true" tabindex="-1"></a>            )</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<p>Using claudette has made this function really easy. Because claudette already takes care of state, and past messages, that is something we don’t have to worry about and can simply delegate to Claudette to take care of it all.</p>
<p>Once we get a request, we can get a timestamp, and if the user responds in a thread itself, then we get the timestamp from the thread. Next, we extract the message as a string and pass it over to claudette.</p>
<p>Using <code>toolloop</code> allows claudette to make function calls directly to Claude and return the answer. A sample conversation on Slack using this setup looks something like below.</p>
<div class="quarto-video"><video id="video_shortcode_videojs_video2" class="video-js vjs-default-skin vjs-fluid" controls="" preload="auto" data-setup="{}" title="Claudette in Slack"><source src="../images/claudette.mp4"></video></div>
<p>The complete python script can be found in the gist - <a href="https://gist.github.com/amaarora/20db372c5a867bb0d6c7bca8082e4827">here</a>.</p>
</section>
<section id="conclusion" class="level2" data-number="4">
<h2 data-number="4" class="anchored" data-anchor-id="conclusion"><span class="header-section-number">4</span> Conclusion</h2>
<p>As part of this blog post, we explored integrating Claudette with slack-sdk, to use Claude Sonnet 3.5 as a customer support agent.</p>
<p>Using claudette for function calling made this process much easier and allowed Claude to make multiple function calls using a simple method called <code>toolloop</code>. We no longer have to worry about having to define functions as well, as claudette already takes care of it all for us.</p>
<p>By the way, claudette also support images, and there is an example to create a simple code-interpreter in the docs. Be sure to check them <a href="https://claudette.answer.ai/">here</a>.</p>
<p>Thanks for reading!</p>


</section>

<link href="//cdn-images.mailchimp.com/embedcode/classic-071822.css" rel="stylesheet" type="text/css"><div id="mc_embed_signup">
    <form action="https://github.us4.list-manage.com/subscribe/post?u=e847230346a7c78d4745ae796&amp;id=7a63b2b273&amp;f_id=005f58e8f0" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate="">
        <div id="mc_embed_signup_scroll">
        <h2 class="anchored">Subscribe to Aman Arora's blog:</h2>
        <div class="indicates-required"><span class="asterisk">*</span> indicates required</div>
<div class="mc-field-group">
    <label for="mce-EMAIL">Email Address  <span class="asterisk">*</span>
</label>
    <input type="email" value="" name="EMAIL" class="required email" id="mce-EMAIL" required="">
    <span id="mce-EMAIL-HELPERTEXT" class="helper_text"></span>
</div>
<div hidden="true"><input type="hidden" name="tags" value="7232948"></div>
    <div id="mce-responses" class="clear foot">
        <div class="response" id="mce-error-response" style="display:none"></div>
        <div class="response" id="mce-success-response" style="display:none"></div>
    </div>    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_e847230346a7c78d4745ae796_7a63b2b273" tabindex="-1" value=""></div>
        <div class="optionalParent">
            <div class="clear foot">
                <input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button">
                <p class="brandingLogo"><a href="http://eepurl.com/il3baM" title="Mailchimp - email marketing made easy and fun"><img src="https://eep.io/mc-cdn-images/template_images/branding_logo_text_dark_dtp.svg"></a></p>
            </div>
        </div>
    </div>
</form>
</div><script type="text/javascript">(function($) {window.fnames = new Array(); window.ftypes = new Array();fnames[0]='EMAIL';ftypes[0]='email';fnames[1]='FNAME';ftypes[1]='text';fnames[2]='LNAME';ftypes[2]='text';fnames[3]='ADDRESS';ftypes[3]='address';fnames[4]='PHONE';ftypes[4]='phone';fnames[5]='BIRTHDAY';ftypes[5]='birthday';}(jQuery));var $mcj = jQuery.noConflict(true);</script></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<script>videojs(video_shortcode_videojs_video1);</script>
<script>videojs(video_shortcode_videojs_video2);</script>




</body></html>